define(["ui/HeadHPBar","ui/Magic/MagicFactory"],function(n,t){function i(n,t,i,r){this.initialize(n,t,i,r)}return i.prototype=new CJ.Container,i.prototype.Container_initialize=i.prototype.initialize,i.prototype.initialize=function(t,i,r,u){var f,e;this.Container_initialize(),this.id=t,this.name=i,this.speed=u,this.position=r,this.offsetPositon=new Vector2(0,0),this.path=[],this.enemys=[],this.speed=u,this.realSpeed=u,this.level=1,this.prePositionX=-1,this.prePositionY=-1,Global.player&&(this.preViewPortX=Global.player.viewPort[0],this.preViewPortY=Global.player.viewPort[1]),this.centerHeight=45,f=new CJ.SpriteSheet({images:[Resource.getRes("role")],frames:Resource.getFrames("role"),animations:{stand0:[0,2,"stand0",10],walk0:[3,8,"walk0",4],attack0:[9,13,"attack0",5],magicAttack0:[14,19,"magicAttack0",5],hurt0:{frames:[20,20],next:"stand0",frequency:8},die0:[21,22,"",3],stand1:[23,25,"stand1",10],walk1:[26,31,"walk1",4],attack1:[32,36,"attack1",5],magicAttack1:[37,42,"magicAttack1",5],hurt1:{frames:[43,43],next:"stand1",frequency:8},die1:[44,45,"",3],stand2:[46,48,"stand2",10],walk2:[49,54,"walk2",4],attack2:[55,59,"attack2",5],magicAttack2:[60,65,"magicAttack2",5],hurt2:{frames:[66,66],next:"stand2",frequency:8},die2:[67,68,"",3],stand3:[69,71,"stand3",10],walk3:[72,77,"walk3",4],attack3:[78,82,"attack3",5],magicAttack3:[83,88,"magicAttack3",5],hurt3:{frames:[89,89],next:"stand3",frequency:8},die3:[90,91,"",3],stand4:[92,94,"stand4",10],walk4:[95,100,"walk4",4],attack4:[101,105,"attack4",5],magicAttack4:[106,111,"magicAttack4",5],hurt4:{frames:[112,112],next:"stand4",frequency:8},die4:[113,114,"",3]}}),CJ.SpriteSheetUtils.addFlippedFrames(f,!0,!1,!1),this.bmpAnim=new CJ.BitmapAnimation(f),e=this,this.bmpAnim.onClick=function(){Global.targetPlayer=e},this.direction=MathHelp.getRandomNumber(0,7),this.bmpAnim.gotoAndPlay("stand"+this.getFrameName()),this.addChild(this.bmpAnim),this.moveLength=new Vector2(0,0),this.expTotalValue=0,this.height=95,this.HP=1e5,this.totalHP=1e5,this.headHPBar=new n(this,50,5),this.currentCell=Global.map.getSmallCellIndex(this.position),this.addChild(this.headHPBar)},i.prototype.init=function(){this.currentCell=Global.map.getSmallCellIndex(this.position),this.setAlpha(),this.updateViewPort(),Global.map.updateMapByViewPort(this.viewPort),this.setStagePosition(Global.map)},i.prototype.updateViewPort=function(){this.viewPort=[this.position.x-Global.canvas.width/2,this.position.y-Global.canvas.height/2,Global.canvas.width,Global.canvas.height],this.viewPort[0]<0&&(this.viewPort[0]=0),this.viewPort[0]+Global.canvas.width>Global.map.cellWidth*Global.map.horizontalCount&&(this.viewPort[0]=Global.map.cellWidth*Global.map.horizontalCount-Global.canvas.width),this.viewPort[1]<0&&(this.viewPort[1]=0),this.viewPort[1]+Global.canvas.height>Global.map.cellHeight*Global.map.verticalCount&&(this.viewPort[1]=Global.map.cellHeight*Global.map.verticalCount-Global.canvas.height)},i.prototype.setAlpha=function(){this.alpha=_.include(Global.map.mask,this.currentCell.x+"_"+this.currentCell.y)?.5:1},i.prototype.tick=function(){var n;if(this.speed=parseInt(this.realSpeed*60/CJ.Ticker.getMeasuredFPS()),this.HP<=0){this.die(),this.removeChild(this.headHPBar);return}if(Global.player&&this.id!==Global.player.id&&this.setStagePosition(),this.path.length>0){Global.player&&this.id===Global.player.id&&(this.updateViewPort(),Global.map.updateMapByViewPort(this.viewPort)),this.setStagePosition();var r=this.path[0],u=new Vector2(r[0],r[1]),t=Global.map.getPositionBySmallCellIndex(u),i=t.sub(this.position).setLength(this.speed),f=this.getDirection(u);if(f!==-1&&(this.direction=f),this.walk(),this.position.x+=i.x,this.position.y+=i.y,(this.position.distanceToSquared(t)<parseInt(1500/CJ.Ticker.getMeasuredFPS())||i.x===0&&i.y===0)&&(this.path.shift(),this.path.length===0&&(this.position.x=t.x,this.position.y=t.y),this.currentCell=Global.map.getSmallCellIndex(this.position),this.id==Global.player.id))for(n=0;n<Global.transports.length;n++)if(Global.transports[n].cellPosition.distanceToSquared(this.currentCell)<4){this.path.length=0,Global.scene.destroy(),Global.initSceneMapID=Global.transports[n].targetMapID,Global.initScenePosition=Global.transports[n].playerPosition,Global.scene.mapID=Global.transports[n].targetMapID,Global.scene.init();return}}else this.bmpAnim.currentAnimation.indexOf("magicAttack")===-1&&this.bmpAnim.currentAnimation.indexOf("hurt")===-1&&this.stand()},i.prototype.setStagePosition=function(){var n;Global.player&&this.id!==Global.player.id?((this.preViewPortX!==Global.player.viewPort[0]||this.preViewPortY!==Global.player.viewPort[1])&&(n=Global.player.getStagePosition().add(this.position.sub(Global.player.position)),this.x=parseInt(n.x),this.y=parseInt(n.y),this.preViewPortX=Global.player.viewPort[0],this.preViewPortY=Global.player.viewPort[1]),(this.prePositionX!==this.position.x||this.prePositionY!==this.position.y)&&(n=Global.player.getStagePosition().add(this.position.sub(Global.player.position)),this.x=parseInt(n.x),this.y=parseInt(n.y),this.prePositionX=this.position.x,this.prePositionY=this.position.y,this.setAlpha())):(this.prePositionX!==this.position.x||this.prePositionY!==this.position.y)&&(this.x=this.position.x<Global.canvas.width/2?this.position.x:Global.map.cellWidth*Global.map.horizontalCount-this.position.x<Global.canvas.width/2?Global.canvas.width-(Global.map.cellWidth*Global.map.horizontalCount-this.position.x):Global.canvas.width/2,this.y=this.position.y<Global.canvas.height/2?this.position.y:Global.map.cellHeight*Global.map.verticalCount-this.position.y<Global.canvas.height/2?Global.canvas.height-(Global.map.cellHeight*Global.map.verticalCount-this.position.y):Global.canvas.height/2,this.setAlpha())},i.prototype.getDirection=function(n){var t=n.x-this.currentCell.x,i=n.y-this.currentCell.y;return t===0&&i<0?0:t>0&&i<0?1:t>0&&i===0?2:t>0&&i>0?3:t===0&&i>0?4:t<0&&i>0?5:t<0&&i===0?6:t<0&&i<0?7:-1},i.prototype.getFrameName=function(){return this.direction==0?"0":this.direction==1?"1":this.direction==2?"2":this.direction==3?"3":this.direction==4?"4":this.direction==5?"3_h":this.direction==6?"2_h":this.direction==7?"1_h":void 0},i.prototype.getStagePosition=function(){return new Vector2(this.x,this.y)},i.prototype.magicShow=function(n){var i=this,r,u;i.path.length=0,u=new Vector2(i.position.x,i.position.y-i.centerHeight),this.target&&this.target.HP>0?(r=this.target.position.sub(new Vector2(0,this.target.height/3)),i.r=MathHelp.getRotation(u,r),i.setDirByR(),i.bmpAnim.currentAnimation.indexOf("magicAttack"+i.getFrameName())===-1&&(i.bmpAnim.gotoAndPlay("magicAttack"+i.getFrameName()),i.bmpAnim.onAnimationEnd=function(){SoundJS.play("magic",SoundJS.INTERRUPT_ANY),this.onAnimationEnd=null,this.currentAnimation.indexOf("magicAttack")!==-1&&t.create(i,n,u,r),i.stand()})):(r=Global.stageToWorld(new Vector2(Global.stage.mouseX,Global.stage.mouseY)),i.r=MathHelp.getRotation(u,r),i.setDirByR(),i.bmpAnim.currentAnimation.indexOf("magicAttack"+i.getFrameName())===-1&&(i.bmpAnim.gotoAndPlay("magicAttack"+i.getFrameName()),i.bmpAnim.onAnimationEnd=function(){SoundJS.play("magic",SoundJS.INTERRUPT_ANY),this.onAnimationEnd=null,this.currentAnimation.indexOf("magicAttack")!==-1&&t.create(i,n,u,r),i.stand()}))},i.prototype.setDirByR=function(){if(this.r>=-112.5&&this.r<=-67.5){this.direction=0;return}if(this.r>-67.5&&this.r<=-22.5){this.direction=1;return}if(this.r>-22.5&&this.r<=22.5){this.direction=2;return}if(this.r>22.5&&this.r<=67.5){this.direction=3;return}if(this.r>67.5&&this.r<=112.5){this.direction=4;return}if(this.r>112.5&&this.r<=157.5){this.direction=5;return}if(Math.abs(this.r)>=157.5&&Math.abs(this.r)<=180){this.direction=6;return}if(this.r>-157.5&&this.r<-112.5){this.direction=7;return}},i.prototype.subHP=function(n){this.HP-=n,this.HP<0&&(this.HP=0),this.updateHeadHPBar(),Global.ht.updateHP();var t=new CJ.Text;n<10&&(t.regX=17),n>=10&&n<100&&(t.regX=25),n>=100&&(t.regX=35),t.y=-this.height,t.color="red",t.font="bold 20pt Calibri ",t.text="-"+n,this.addChild(t),CJ.Tween.get(t).to({alpha:0,y:t.y-80},1e3).call(function(){this.parent&&this.parent.removeChild(this)})},i.prototype.stand=function(){this.bmpAnim.currentAnimation!="stand"+this.getFrameName()&&this.bmpAnim.gotoAndPlay("stand"+this.getFrameName())},i.prototype.walk=function(){this.bmpAnim.currentAnimation!="walk"+this.getFrameName()&&this.bmpAnim.gotoAndPlay("walk"+this.getFrameName())},i.prototype.attack=function(){this.bmpAnim.currentAnimation!="attack"+this.getFrameName()&&this.bmpAnim.gotoAndPlay("attack"+this.getFrameName())},i.prototype.magicAttack=function(){this.bmpAnim.currentAnimation!="magicAttack"+this.getFrameName()&&this.bmpAnim.gotoAndPlay("magicAttack"+this.getFrameName())},i.prototype.hurt=function(){this.bmpAnim.currentAnimation!="hurt"+this.getFrameName()&&this.bmpAnim.gotoAndPlay("hurt"+this.getFrameName())},i.prototype.die=function(){this.bmpAnim.currentAnimation!="die"+this.getFrameName()&&this.bmpAnim.gotoAndPlay("die"+this.getFrameName())},i.prototype.addHP=function(n){this.HP+=n,this.updateHeadHPBar();var t=new CJ.Text;n<10&&(t.regX=17),n>=10&&n<100&&(t.regX=25),n>=100&&(t.regX=35),t.y=-this.height,t.color="#69D025",t.font="bold 20pt Calibri ",t.text="+"+n,this.addChild(t),CJ.Tween.get(t).to({alpha:0,y:t.y-80},1e3).call(function(){this.parent&&this.parent.removeChild(this)})},i.prototype.updateHeadHPBar=function(){this.headHPBar.setHP(this.HP)},i.prototype.addExp=function(n){this.expTotalValue+=parseInt(n),this.expTotalValue>=Global.levelUpExp[this.level-1]&&(this.expTotalValue-=Global.levelUpExp[this.level-1],this.level+=1,this.levelUp()),this.id==Global.player.id&&(Global.eb.setProgress(this.expTotalValue/Global.levelUpExp[this.level-1]),Global.ht.setLevel(this.level));var t=new CJ.Text;n<10&&(t.regX=25),n>=10&&n<100&&(t.regX=30),n>=100&&(t.regX=40),t.y=-this.height,t.color="#69D025",t.font="bold 20pt Calibri ",t.text="Exp+"+n,this.addChild(t),CJ.Tween.get(t).to({alpha:0,y:t.y-MathHelp.getRandomNumber(100,200)},MathHelp.getRandomNumber(1e3,1500)).call(function(){this.parent&&this.parent.removeChild(this)})},i.prototype.levelUp=function(){var i=new CJ.SpriteSheet({images:[Resource.getRes("levelup")],frames:Resource.getFrames("levelup"),animations:{show:[0,2,"",20]}}),n=new CJ.BitmapAnimation(i),t;n.x=18,n.y=38,n.gotoAndPlay("show"),t=this,n.onAnimationEnd=function(){this.parent.removeChild(this);var n=new CJ.Text;n.x=-80,n.y=-t.height,n.color="#69D025",n.font="bold 30pt Calibri ",n.text="LEVEL UP",t.addChild(n),CJ.Tween.get(n).to({alpha:0,y:n.y-150},1500).call(function(){this.parent&&this.parent.removeChild(this)}),t.bmpAnim.alpha=1},this.addChild(n),this.bmpAnim.alpha=.5},i.prototype.destroy=function(){Global.players.splice(Global.players.indexOf(this),1),CJ.Ticker.removeListener(this),this.removeAllChildren(),this.parent.removeChild(this)},i})