define(function(){var n=function(n,t,i,r,u,f){this.initialize(n,t,i,r,u,f)};return n.prototype=new CJ.Container,n.prototype.Container_initialize=n.prototype.initialize,n.prototype.initialize=function(n,t,i,r){var o,s;this.Container_initialize(),this.name=t,this.position=i,this.player=n;var h=Resource.getRes(t),u=[],c=Resource.getFramesNoReg(t),e=0,f=0;$(c).each(function(n){u[n]=this.value,this.id.indexOf("d")>=0&&(u[n].push(0),u[n].push(u[n][2]/2),u[n].push(u[n][3]/2),f++),this.id.indexOf("s")>=0&&this.id.indexOf("ss")<0&&(u[n].push(0),u[n].push(0),u[n].push(u[n][3]/2),e++)}),o={frames:u,animations:{disappear:[0,f-1,"",5],show:[f,f+e-1,"show",5]},images:[h]},this.magicWidth=parseInt(u[f][2]),s=new CJ.SpriteSheet(o),this.speed=10,this.sortRetTag=!0,this.prePositionX=-1,this.prePositionY=-1,this.preViewPortX=Global.player.viewPort[0],this.preViewPortY=Global.player.viewPort[1],this.setStagePosition(),this.targetWorldPosition=r,this.rotation=MathHelp.getRotation(this.position,this.targetWorldPosition),this.animation=new CJ.BitmapAnimation(s),this.animation.gotoAndPlay("show"),this.position.distanceToSquared(this.targetWorldPosition)<this.magicWidth*this.magicWidth&&(this.speed=0),this.addChild(this.animation),CJ.Ticker.addListener(this)},n.prototype.tick=function(){this.position.x+=this.speed*Math.cos(this.rotation*Math.PI/180),this.position.y+=this.speed*Math.sin(this.rotation*Math.PI/180),this.setFlyMagicEnd(),this.setStagePosition()},n.prototype.setFlyMagicEnd=function(){var n=this,t;this.x<=0||this.x>Global.stage.canvas.width||this.y<=0||this.y>Global.stage.canvas.height?this.destroy():this.speed===0?this.animation.currentAnimation.indexOf("disappear")===-1&&(this.position.x=this.targetWorldPosition.x,this.position.y=this.targetWorldPosition.y,this.animation.gotoAndPlay("disappear"),this.player.target&&this.player.target.HP>0&&(this.player.target.subHP(MathHelp.getRandomNumber(100,200)),this.player.target.target=this.player,this.player.enemys.push(this.player.target)),this.animation.onAnimationEnd=function(){n.animation.currentAnimation.indexOf("disappear")!==-1&&n.destroy()}):(t=new Vector2(this.position.x+this.magicWidth,this.position.y),t.rotateSelf(new Vector2(this.position.x,this.position.y),this.rotation),t.distanceToSquared(this.targetWorldPosition)<200&&this.animation.currentAnimation.indexOf("disappear")===-1&&(this.position=Global.stageToWorld(new Vector2(this.player.target.x,this.player.target.y-this.player.target.height/3)),this.animation.gotoAndPlay("disappear"),this.player.target&&this.player.target.HP>0&&this.player.id==Global.player.id&&(this.player.target.subHP(MathHelp.getRandomNumber(100,200)),this.player.target.target=this.player,this.player.enemys.push(this.player.target)),this.animation.onAnimationEnd=function(){n.animation.currentAnimation.indexOf("disappear")!==-1&&n.destroy()},this.speed=0))},n.prototype.destroy=function(){this.animation!=null&&this.animation.stop(),CJ.Ticker.removeListener(this),this.removeAllChildren(),Global.PGCTT.removeChild(this)},n.prototype.setStagePosition=function(){if((this.preViewPortX!==Global.player.viewPort[0]||this.preViewPortY!==Global.player.viewPort[1])&&(this.x+=this.preViewPortX-Global.player.viewPort[0],this.y+=this.preViewPortY-Global.player.viewPort[1],this.preViewPortX=Global.player.viewPort[0],this.preViewPortY=Global.player.viewPort[1]),this.prePositionX!==this.position.x||this.prePositionY!==this.position.y){var n=Global.worldToStage(this.position);this.x=parseInt(n.x),this.y=parseInt(n.y),this.prePositionX=this.position.x,this.prePositionY=this.position.y}},n})