define(["ui/Map/Map","ui/player","ui/Map/MiniMap","ui/Map/LowPixelMap","ui/ClickAnm","ui/Transport","ui/Playground","ui/Enemy","ui/playerFactory","ui/NPC"],function(n,t,i,r,u,f,e,o,s,h){function c(n,t,i,r){this.initialize(n,t,i,r)}return c.prototype=new CJ.Container,c.prototype.Container_initialize=c.prototype.initialize,c.prototype.initialize=function(n,t,i,r){this.Container_initialize(),this.mapID=n,this.playerid=t,this.playername=i,this.positionfromserver=r},c.prototype.init=function(){var it,w,b,k,c,ut,d,v,a,y,p;Global.PGCTT=new e;var t=this,g="",rt="",l="",o="",nt,tt;for($(Resource.getRes("mapConfig")).find("Maps").each(function(){$(this).find("Map").each(function(){$(this).attr("ID")==t.mapID&&(g=$(this).attr("Obstruction").split(","),rt=$(this).attr("Mask").split(","),l=$(this).attr("Transport").split(","),nt=$(this).attr("HorizontalCount"),tt=$(this).attr("VerticalCount"),$(this).find("Enemy").each(function(){o+=$(this).attr("Name"),o+="|",o+=$(this).attr("Position"),o+="|",o+=$(this).attr("HP"),o+="|",o+=$(this).attr("MP"),o+="|",o+=$(this).attr("EXP"),o+="|",o+=$(this).attr("Speed"),o+="|",o+=$(this).attr("AwakeScope"),o+="|",o+=$(this).attr("SleepScope"),o+="&"}))})}),it=[],w=0;w<nt;w++){for(b=[],k=0;k<tt;k++)_.include(g,w+"_"+k)?b.push(1):b.push(0);it.push(b)}for(Global.astar=new Astar(it),Global.map=t.map=new n(t.mapID,nt/5,tt/10,300,300,60,30,rt,g),Global.player?(Global.player.position=t.map.getPositionBySmallCellIndex(Global.initScenePosition),Global.player.init()):(Global.player=s.buildPlayer(Global.playerID,t.playername,new Vector2(930,615)),Global.player.init()),CJ.Ticker.addListener(Global.player),o!=""&&(o=o.substring(0,o.length-1),t.initEnemy(o)),t.lpMap=new r(t.mapID),CJ.Ticker.addListener(t.lpMap),t.clickAnmContainter=new CJ.Container,this.addChild(t.lpMap,t.map),Global.transports.length=0,c=0;c<l.length;c++)ut=t.map.getPositionBySmallCellIndex({x:l[c].split("|")[0].split("_")[0],y:l[c].split("|")[0].split("_")[1]}),d=new f(new Vector2(l[c].split("|")[0].split("_")[0],l[c].split("|")[0].split("_")[1]),ut,l[c].split("|")[1],l[c].split("|")[2]),Global.transports.push(d),CJ.Ticker.addListener(d),this.addChild(d);v=new h,v.x=400,v.y=400,v.onClick=function(){console.log(1)},Global.PGCTT.addChild(v),Global.PGCTT.addChild(Global.player),CJ.Ticker.addListener(Global.PGCTT),this.addChild(t.clickAnmContainter,Global.PGCTT),t.lpMap.onClick=t.map.onClick=function(){var i=new u(new Vector2(Global.stage.mouseX,Global.stage.mouseY)),n;CJ.Ticker.addListener(i),t.clickAnmContainter.addChild(i),Global.player.currentCell=t.map.getSmallCellIndex(Global.player.position),t.map.isCellInObstruction(Global.player.currentCell.x,Global.player.currentCell.y)||(Global.player.endCellPositon=t.map.getSmallCellIndex(Global.player.position.add(new Vector2(Global.stage.mouseX,Global.stage.mouseY).sub(Global.player.getStagePosition()))),Global.astar.map[Global.player.currentCell.x][Global.player.currentCell.y]=0,n=Global.astar.getPath(Global.player.currentCell.x,Global.player.currentCell.y,Global.player.endCellPositon.x,Global.player.endCellPositon.y),n.shift(),n.length>0&&(Global.player.currentCell=Global.map.getSmallCellIndex(Global.player.position),Global.player.path=n))},t.mm=new i(t.mapID,200,140),t.mm.x=820,t.mm.y=30,this.addChild(t.mm),CJ.Ticker.addListener(t.mm),t.mm.onClick=function(){Global.player.currentCell=t.map.getSmallCellIndex(Global.player.position),Global.astar.map[Global.player.currentCell.x][Global.player.currentCell.y]=0,Global.player.endCellPositon=t.map.getSmallCellIndex({x:10*(Global.stage.mouseX-t.mm.x+t.mm.bitmap.sourceRect.x),y:10*(Global.stage.mouseY-t.mm.y+t.mm.bitmap.sourceRect.y)});var n=Global.astar.getPath(Global.player.currentCell.x,Global.player.currentCell.y,Global.player.endCellPositon.x,Global.player.endCellPositon.y);n.shift(),n.length>0&&(Global.player.currentCell=Global.map.getSmallCellIndex(Global.player.position),Global.player.path=n)},a=new CJ.Bitmap(Resource.getRes("border_702@11-17-11-27")),a.x=t.mm.x-3,a.scaleX=3,a.scaleY=1.2,y=new CJ.Text("位置：","15px Arial","#DCD181"),p=new CJ.Text("长安","bold 15px Arial","#00FF12"),y.textBaseline="top",p.textBaseline="top",y.x=a.x+23,y.y=p.y=10,p.x=a.x+60,t.addChild(a,y,p)},c.prototype.initEnemy=function(n){for(var e=n.split("&"),t,u,i,f,r=0;r<e.length;r++)for(t=e[r].split("|"),u=t[1].split(","),i=0;i<u.length;i++)f=new o(t[0],this.map.getPositionBySmallCellIndex(new Vector2(u[i].split("_")[0],u[i].split("_")[1])),t[2],t[3],t[4],t[5],t[6],t[7]),Global.PGCTT.addChild(f),CJ.Ticker.addListener(f)},c.prototype.destroy=function(){CJ.Ticker.removeListener(Global.PGCTT),CJ.Ticker.removeListener(Global.player),CJ.Ticker.removeListener(this.lpMap),CJ.Ticker.removeListener(this.mm);for(var n=0;n<Global.transports.length;n++)CJ.Ticker.removeListener(Global.transports[n]);Global.PGCTT.removeAllChildren(),Global.PGCTT.addChild(Global.player),Global.enemyArr.length=0,this.removeAllChildren()},c})